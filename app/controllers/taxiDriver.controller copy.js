// controllers/taxiDriver.controller.js

const db = require("../models");
const TaxiDriver = db.taxiDriver;
const axios = require("axios");
// require("dotenv").config();
const pool = require("../config/config.booking");

// Create new driver
exports.create_byAdmin = async (req, res) => {
  try {
    const taxi_id = `Ta-${String(Date.now()).slice(-6)}`;

    const { taxi_lpr, driver, line_name, line_user_id } = req.body;
    console.log("TaxiDriver Model: ", TaxiDriver);
    const newDriver = await TaxiDriver.create({
      taxi_id,
      taxi_lpr,
      driver,
      line_name,
      line_user_id,
    });

    res.status(201).send(newDriver);
  } catch (err) {
    console.error("üî• Sequelize error: ", err);
    res.status(500).send({ message: err.message, error: err.errors });
  }
};

exports.create_byDriver = async (req, res) => {
  try {
    const taxi_id = `Ta-${String(Date.now()).slice(-6)}`;
    const { taxi_lpr, driver, phone, line_name, line_user_id } = req.body;

    // console.log("TaxiDriver line_user_id: ", line_user_id);

    // üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ line_user_id ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    const existingDriver = await TaxiDriver.findOne({
      where: { line_user_id },
    });

    if (existingDriver) {
      // console.log`‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß (line_user_id: ${line_user_id})`;
      return res.status(400).send({
        message: `‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß (line_user_id: ${line_user_id})`,
      });
    }

    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
    const newDriver = await TaxiDriver.create({
      taxi_id,
      taxi_lpr,
      driver,
      phone,
      line_name,
      line_user_id,
    });

    res.status(201).send(newDriver);
  } catch (err) {
    console.error("üî• Sequelize error: ", err);
    res.status(500).send({ message: err.message, error: err.errors });
  }
};

// exports.create_byDriver = async (req, res) => {
//   try {
//     const taxi_id = `Ta-${String(Date.now()).slice(-6)}`;
//     // console.log("LIFF URL being sent:", liffUrl);
//     const { taxi_lpr, driver, phone, line_name, line_user_id } = req.body;
//     const newDriver = await TaxiDriver.create({
//       taxi_id,
//       taxi_lpr,
//       driver,
//       phone,
//       line_name,
//       line_user_id,
//     });

//     res.status(201).send(newDriver);
//   } catch (err) {
//     console.error("üî• Sequelize error: ", err);
//     res.status(500).send({ message: err.message, error: err.errors });
//   }
// };

// Get all drivers
exports.findAll = async (req, res) => {
  try {
    const drivers = await TaxiDriver.findAll();
    res.send(drivers);
  } catch (err) {
    res.status(500).send({ message: err.message });
  }
};

// Update driver by id

exports.update = async (req, res) => {
  try {
    const { taxi_id } = req.body;

    if (!taxi_id) {
      return res
        .status(400)
        .send({ message: "Missing taxi_id in request body." });
    }

    const [updated] = await TaxiDriver.update(req.body, {
      where: { taxi_id: taxi_id },
    });

    if (updated) {
      const updatedDriver = await TaxiDriver.findOne({
        where: { taxi_id: taxi_id },
      });
      return res.send(updatedDriver);
    }

    res.status(404).send({ message: "Driver not found" });
  } catch (err) {
    res.status(500).send({ message: err.message });
  }
};

exports.delete = async (req, res) => {
  try {
    const { taxi_id } = req.body;

    if (!taxi_id) {
      return res
        .status(400)
        .send({ message: "Missing taxi_id in request body." });
    }

    const deleted = await TaxiDriver.destroy({
      where: { taxi_id: taxi_id },
    });

    if (deleted) {
      return res.send({
        message: `Driver with taxi_id ${taxi_id} deleted successfully.`,
      });
    }

    res.status(404).send({ message: "Driver not found." });
  } catch (err) {
    res.status(500).send({ message: err.message });
  }
};

// line
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå LINE ‡∏à‡∏≤‡∏Å user ID
// ‡∏£‡∏±‡∏ö webhook ‡∏à‡∏≤‡∏Å LINE Messaging API

exports.handleLineWebhook = async (req, res) => {
  try {
    const events = req.body.events || [];

    console.log("üì® events", events);

    for (const event of events) {
      const line_user_id = event.source.userId;

      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡∏ó‡∏≥‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á message ‡πÅ‡∏•‡∏∞ postback)
      const driver = await TaxiDriver.findOne({ where: { line_user_id } });

      // ‡∏Å‡∏£‡∏ì‡∏µ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡πà‡∏á message ‡∏´‡∏£‡∏∑‡∏≠ postback)
      if (!driver) {
        // ‡∏™‡πà‡∏á Flex message ‡∏ä‡∏ß‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
        const LIFF_URL_USE = `${process.env.LIFF_URL}?line_user_id=${line_user_id}`;
        console.log("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö line_user_id ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        console.log("üîó LIFF_URL_USE:", LIFF_URL_USE);

        await axios.post(
          "https://api.line.me/v2/bot/message/reply",
          {
            replyToken: event.replyToken,
            messages: [
              {
                type: "flex",
                altText: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏Å‡∏ã‡∏µ‡πà",
                contents: {
                  type: "bubble",
                  size: "mega",
                  hero: {
                    type: "image",
                    url: "https://chs.westwind.ab.ca/uploads/1259/registrationicon.png",
                    size: "full",
                    aspectRatio: "20:13",
                    aspectMode: "cover",
                  },
                  body: {
                    type: "box",
                    layout: "vertical",
                    spacing: "md",
                    contents: [
                      {
                        type: "text",
                        text: "‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô",
                        weight: "bold",
                        size: "lg",
                        wrap: true,
                      },
                      {
                        type: "text",
                        text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤ LIFF App",
                        size: "sm",
                        color: "#666666",
                        wrap: true,
                      },
                    ],
                  },
                  footer: {
                    type: "box",
                    layout: "vertical",
                    spacing: "sm",
                    contents: [
                      {
                        type: "button",
                        style: "primary",
                        color: "#0F8B8D",
                        action: {
                          type: "uri",
                          label: "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ",
                          uri: LIFF_URL_USE,
                        },
                      },
                    ],
                  },
                },
              },
            ],
          },
          {
            headers: {
              Authorization: `Bearer ${process.env.LINE_CHANNEL_ACCESS_TOKEN}`,
              "Content-Type": "application/json",
            },
          }
        );

        continue; // ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏Ç‡∏≠‡∏á for
      }

      // ‡∏Å‡∏£‡∏ì‡∏µ event ‡πÄ‡∏õ‡πá‡∏ô postback
      if (event.type === "postback") {
        const postbackData = event.postback?.data || "";
        console.log("üì® ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö postback:", postbackData);

        if (postbackData.includes("action=confirm")) {
          const bookingIdMatch = postbackData.match(/bookingId=([^&]+)/);
          const bookingId = bookingIdMatch ? bookingIdMatch[1] : "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";

          console.log(
            `‚úÖ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${line_user_id} ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏á‡∏≤‡∏ô Booking ID: ${bookingId}`
          );

          //  ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô DB ‡∏î‡πâ‡∏ß‡∏¢ bookingId
          // ‡πÄ‡∏≠‡∏≤ line_user_id ‡πÑ‡∏õ find ‡πÉ‡∏ô table taxiDriver ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á ‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
          // ‡πÄ‡∏≠‡∏≤ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏õ find ‡πÉ‡∏ô table HappyData field =Booking_id  ‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà field ‡πÑ‡∏´‡∏ô =TAXI_lpr_go / TAXI_lpr_back
          // ‡∏ñ‡πâ‡∏≤  = TAXI_lpr_go ‡πÉ‡∏´‡πâ update CONFIRM_go
          // ‡∏ñ‡πâ‡∏≤  = TAXI_lpr_back ‡πÉ‡∏´‡πâ update CONFIRM_back

          try {
            //todo ---- update confirm
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LPR
            const driver = await TaxiDriver.findOne({
              where: { line_user_id },
            });

            if (!driver) {
              console.log("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö line_user_id ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô table taxiDriver");
              return;
            }

            const taxi_lpr = driver.taxi_lpr; // ‡∏´‡∏£‡∏∑‡∏≠ driver.plate_number ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô DB
            console.log("üöï ‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô taxi_lpr =", taxi_lpr);

            // ‡πÄ‡∏≠‡∏≤ bookingId ‡πÅ‡∏•‡∏∞ taxi_lpr find rows ‡πÉ‡∏ô HappyData
            const connection = await pool.getConnection();
            const [rows] = await connection.execute(
              `
              SELECT * FROM HappyData 
              WHERE Booking_ID = ? 
              AND (TAXI_lpr_go = ? OR TAXI_lpr_back = ?)
              `,
              [bookingId, taxi_lpr, taxi_lpr]
            );

            if (rows.length === 0) {
              console.log("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô HappyData");
            } else {
              const row = rows[0];
              let confirmField = null;

              if (row.TAXI_lpr_go === taxi_lpr) {
                confirmField = "CONFIRM_go";
              } else if (row.TAXI_lpr_back === taxi_lpr) {
                confirmField = "CONFIRM_back";
              }

              if (confirmField) {
                console.log(`üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ü‡∏¥‡∏•‡∏î‡πå ${confirmField} ‡πÄ‡∏õ‡πá‡∏ô "ok"`);

                await connection.execute(
                  `UPDATE HappyData SET ${confirmField} = ? WHERE Booking_ID = ?`,
                  ["ok", bookingId]
                );

                console.log("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
              } else {
                console.log("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡πà‡∏≤ taxi_lpr ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö go ‡∏´‡∏£‡∏∑‡∏≠ back");
              }
            }

            // todo -- end
            // ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì
            await axios.post(
              "https://api.line.me/v2/bot/message/reply",
              {
                replyToken: event.replyToken,
                messages: [
                  {
                    type: "text",
                    text: `‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏á‡∏≤‡∏ô Booking ID: ${bookingId} ‡∏Ñ‡πà‡∏∞`,
                  },
                ],
              },
              {
                headers: {
                  Authorization: `Bearer ${process.env.LINE_CHANNEL_ACCESS_TOKEN}`,
                  "Content-Type": "application/json",
                },
              }
            );
          } catch (error) {
            console.error(
              "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï CONFIRM:",
              error.message
            );
          }

          continue; // ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
        }

        if (postbackData.includes("action=reject")) {
          const bookingIdMatch = postbackData.match(/bookingId=([^&]+)/);
          const bookingId = bookingIdMatch ? bookingIdMatch[1] : "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";

          console.log(
            `‚ùå ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${line_user_id} ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏á‡∏≤‡∏ô Booking ID==>: ${bookingId}`
          );

          try {
            // ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö
            await axios.post(
              "https://api.line.me/v2/bot/message/reply",
              {
                replyToken: event.replyToken,
                messages: [
                  {
                    type: "text",
                    text: `‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏á‡∏≤‡∏ô Booking ID: ${bookingId} ‡∏Ñ‡πà‡∏∞`,
                  },
                ],
              },
              {
                headers: {
                  Authorization: `Bearer ${process.env.LINE_CHANNEL_ACCESS_TOKEN}`,
                  "Content-Type": "application/json",
                },
              }
            );
          } catch (error) {
            console.error(
              "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï CONFIRM:",
              error.message
            );
          }

          continue;
        }
      }

      // ‡∏Å‡∏£‡∏ì‡∏µ event ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (message)
      if (event.type === "message" && event.message.type === "text") {
        const userText = (event.message.text || "").toLowerCase();

        if (userText.includes("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß")) {
          console.log(
            `‚úÖ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${line_user_id} ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°====: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß`
          );

          await axios.post(
            "https://api.line.me/v2/bot/message/reply",
            {
              replyToken: event.replyToken,
              messages: [{ type: "text", text: "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏∞" }],
            },
            {
              headers: {
                Authorization: `Bearer ${process.env.LINE_CHANNEL_ACCESS_TOKEN}`,
                "Content-Type": "application/json",
              },
            }
          );

          continue;
        }

        if (userText.includes("‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏á‡∏≤‡∏ô")) {
          console.log(`‚ùå ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${line_user_id} ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°=: ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏á‡∏≤‡∏ô`);

          // console.log("üì® events", events[0].message.text);

          // TODO: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÉ‡∏ô DB
          // confirm = "cancle"

          try {
            //Todo ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÉ‡∏ô DB start

            const userText = event.message.text || "";

            // ‡πÉ‡∏ä‡πâ RegExp ‡∏´‡∏≤ bookingId ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            const bookingIdMatch = userText.match(
              /Booking ID:\s*([a-zA-Z0-9]+)/
            );

            const booking_Id = bookingIdMatch ? bookingIdMatch[1] : null;

            if (booking_Id) {
              console.log("üì¶ ‡∏î‡∏∂‡∏á booking_Id ‡πÑ‡∏î‡πâ:", booking_Id);
            } else {
              console.log("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö booking_Id ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ");
            }

            //===================

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LPR
            const driver = await TaxiDriver.findOne({
              where: { line_user_id },
            });

            if (!driver) {
              console.log("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö line_user_id ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô table taxiDriver");
              return;
            }

            const taxi_lpr = driver.taxi_lpr; // ‡∏´‡∏£‡∏∑‡∏≠ driver.plate_number ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô DB
            console.log("üöï ‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô taxi_lpr =", taxi_lpr);

            // ‡πÄ‡∏≠‡∏≤ bookingId ‡πÅ‡∏•‡∏∞ taxi_lpr find rows ‡πÉ‡∏ô HappyData
            const connection = await pool.getConnection();
            const [rows] = await connection.execute(
              `
              SELECT * FROM HappyData 
              WHERE Booking_ID = ? 
              AND (TAXI_lpr_go = ? OR TAXI_lpr_back = ?)
              `,
              [booking_Id, taxi_lpr, taxi_lpr]
            );

            if (rows.length === 0) {
              console.log("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô HappyData");
            } else {
              const row = rows[0];
              let confirmField = null;

              if (row.TAXI_lpr_go === taxi_lpr) {
                confirmField = "CONFIRM_go";
              } else if (row.TAXI_lpr_back === taxi_lpr) {
                confirmField = "CONFIRM_back";
              }

              if (confirmField) {
                console.log(`üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ü‡∏¥‡∏•‡∏î‡πå ${confirmField} ‡πÄ‡∏õ‡πá‡∏ô "cancle"`);

                await connection.execute(
                  `UPDATE HappyData SET ${confirmField} = ? WHERE Booking_ID = ?`,
                  ["cancle", booking_Id]
                );

                console.log("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
              } else {
                console.log("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡πà‡∏≤ taxi_lpr ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö go ‡∏´‡∏£‡∏∑‡∏≠ back");
              }
            }

            // TODO: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÉ‡∏ô DB --END
            await axios.post(
              "https://api.line.me/v2/bot/message/reply",
              {
                replyToken: event.replyToken,
                messages: [{ type: "text", text: "‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏∞" }],
              },
              {
                headers: {
                  Authorization: `Bearer ${process.env.LINE_CHANNEL_ACCESS_TOKEN}`,
                  "Content-Type": "application/json",
                },
              }
            );
          } catch (error) {
            console.error(
              "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï CONFIRM:",
              error.message
            );
          }

          continue;
        }
      }

      // ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏≠‡∏∞‡πÑ‡∏£
      console.log(`‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö event type: ${event.type}`);
    }

    return res.status(200).send("OK");
  } catch (err) {
    console.error("‚ùå Webhook Error:", err.message);
    return res.status(500).send({ message: "Webhook processing failed." });
  }
};
